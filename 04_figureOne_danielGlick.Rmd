---
title: "Group 2 Covid NYC"
author: "Daniel Glick"
date: "6/21/2022"
output: html_document
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


##Import libraries
```{r}
library(tidycensus)
library(dplyr)
library(tigris)
options(tigris_use_cache = TRUE)
library(tidyverse)
library(scales)
library(modelr)
library(lubridate)


#census_api_key('5b57bbbf7a40056c2e85579c26db150add4a4e17', install = TRUE)
#Your API key has been stored in your .Renviron and can be accessed by Sys.getenv("CENSUS_API_KEY"). To use now, restart R or run `readRenviron("~/.Renviron")`
readRenviron("~/.Renviron")

desired_zipcodes <- read_csv("zipcodes_nyc.csv", col_names = TRUE,  cols(ZipCode = col_character())) %>% rename(GEOID=ZipCode)
#view(desired_zipcodes)


acs_var_2016 <- load_variables(2016, "acs5", cache = TRUE)
view(acs_var_2016)

ACS_data <- get_acs(geography = "zcta", variables = c(total_pop = 'B01003_001', uninsured_19to34 = 'B27010_033', uninsured_35to64 = 'B27010_050', med_income = 'B19013_001', white = 'B02001_002', total_house = 'B11016_001', house_4_fam = 'B11016_005', house_4_nonfam = 'B11016_013', house_5_fam ='B11016_006', house_5_nonfam = 'B11016_014', house_6_fam = 'B11016_007', house_6_nonfam = 'B11016_015', house_7_fam = 'B11016_008', house_7_nonfam = 'B11016_016', public = 'B08301_001', bus = 'B08301_011', age_65to66_male = 'B01001_020', age_67to69_male = 'B01001_021', age_70to74_male = 'B01001_022', age_75to79_male = 'B01001_023', age_80to84_male = 'B01001_024', age_85plus_male = 'B01001_025', age_65to66_female = 'B01001_044', age_67to69_female = 'B01001_045', age_70to74_female = 'B01001_046', age_75to79_female = 'B01001_047', age_80to84_female = 'B01001_048', age_85plus_female = 'B01001_049'), state = 'NY', year = 2016, geometry = TRUE)

#view(ACS_data)
head(ACS_data, 45)


ACS_data_cleaned <- inner_join(desired_zipcodes, ACS_data, on = "GEOID")


head(ACS_data_cleaned, 20)
view(ACS_data_cleaned)
```


##Combine all the rows that need combining and divide by total population to get proportions. 
```{r combine and calculate propportions}

#Total population by zip code
total_byzip <- ACS_data_cleaned %>% filter(variable == "total_pop") %>% rename(total_pop = estimate)
#head(total_byzip)

#Total number taking public transport
public_transport_count <- ACS_data_cleaned %>% filter(grepl("public", variable)) %>% group_by(GEOID) %>%  summarize(take_public = sum(estimate))
#head(public_transport_count)

#total number of people in all households
all_house_sizes <- ACS_data_cleaned %>% filter(grepl("total_house", variable)) %>% group_by(GEOID) %>%  summarize(all_house = sum(estimate))
#head(all_house_sizes)

#proportion 18-64 uninsured
uninsured <- ACS_data_cleaned %>% filter(grepl("^uninsured*", variable)) %>% group_by(GEOID)%>%  summarize(eighteen_to65 = sum(estimate))

uninsured_18to65_byzip <- left_join(uninsured, total_byzip, on = "GEOID") %>% mutate(prop_uninsured = eighteen_to65 / total_pop) %>% select(GEOID, eighteen_to65, total_pop, prop_uninsured, geometry)
#head(uninsured_18to65_byzip)


#Median Income
income_byzip <- ACS_data_cleaned %>% filter(grepl("med_income", variable)) %>% group_by(GEOID)%>%  summarize(median_income = sum(estimate))

  
#proportion of pop that are white
vanilla <- ACS_data_cleaned %>% filter(grepl("white", variable)) %>% group_by(GEOID)%>%  summarize(ident_as_white = sum(estimate))

prop_of_white <- left_join(vanilla, total_byzip, on = "GEOID") %>% mutate(prop_white = ident_as_white / total_pop) %>% select(GEOID, ident_as_white, total_pop, prop_white, geometry)
#head(prop_of_white)


#proportion homes with four or more in the house
house_fourplus <- ACS_data_cleaned %>% filter(grepl("^house_*", variable)) %>% group_by(GEOID) %>% summarize(four_or_more = sum(estimate))
#head(house_fourplus)

prop_fourbyzip <- left_join(house_fourplus, total_byzip, on = "GEOID")
prop_fourbyzip <- left_join(prop_fourbyzip, all_house_sizes, on = "GEOID") %>% mutate(prop_fourplus = four_or_more / all_house) %>% select(GEOID, four_or_more, all_house, prop_fourplus, geometry)
head(prop_fourbyzip)


#proportion using public transport that used bus
amount_on_bus <- ACS_data_cleaned %>% filter(grepl("bus", variable)) %>% group_by(GEOID)  %>%  summarize(take_bus = sum(estimate))
view(amount_on_bus)

prop_public_transport <- left_join(amount_on_bus, total_byzip, on = "GEOID")
prop_public_transport <- left_join(prop_public_transport, public_transport_count, on = "GEOID") %>% mutate(prop_bus = take_bus / take_public) %>% select(GEOID, take_bus, take_public, prop_bus, geometry)
head(prop_public_transport)

  
#proportion of people aged 65+
walkwithcane <- ACS_data_cleaned %>% filter(grepl("^age*", variable)) %>% group_by(GEOID)%>%  summarize(old_as_hell = sum(estimate))

prop_old_people <- left_join(walkwithcane, total_byzip, on = "GEOID") %>% mutate(prop_old = old_as_hell / total_pop) %>% select(GEOID, old_as_hell, total_pop, prop_old, geometry)
#head(prop_old_people)  


#Combine all into one data frame
master_data <- list(prop_old_people, prop_public_transport, prop_fourbyzip, prop_of_white, income_byzip, uninsured_18to65_byzip) %>% reduce(inner_join, by = "GEOID") %>% select(GEOID, prop_old, prop_bus, prop_fourplus, prop_white, median_income, prop_uninsured, geometry)
head(master_data)
```


##Medians 
```{r}
#compute Medians
median(master_data$prop_uninsured, na.rm=TRUE)
median(master_data$median_income, na.rm=TRUE)
median(master_data$prop_fourplus, na.rm=TRUE)
median(master_data$prop_white, na.rm=TRUE)
median(master_data$prop_bus, na.rm=TRUE)
#quantile(master_data$prop_bus, na.rm=TRUE, probs = c(0.25, 0.75))
median(master_data$prop_old, na.rm=TRUE)

```


##Plot Data
```{r plot data}

ggplot(data = master_data, aes(fill = prop_uninsured)) + geom_sf(aes(geometry=geometry)) + scale_fill_distiller(palette = "YlOrRd", direction = 1) + labs(title = "Proportion of 18-64 year olds who are uninsured") + theme_void() + theme(legend.position="bottom")

ggplot(data = master_data, aes(fill = median_income)) + geom_sf(aes(geometry=geometry)) + scale_fill_distiller(palette = "YlGn", direction = 1) + labs(title = "Median Income") + theme_void() + theme(legend.position="bottom")

ggplot(data = master_data, aes(fill = prop_white)) + geom_sf(aes(geometry=geometry)) + scale_fill_distiller(palette = "Purples", direction = 1) + labs(title = "Proportion self-identifying as White") + theme_void() + theme(legend.position="bottom")

ggplot(data = master_data, aes(fill = prop_fourplus)) + geom_sf(aes(geometry=geometry)) + scale_fill_distiller(palette = "YlOrRd", direction = 1) + labs(title = "Proportion in households of 4 or more") + theme_void() + theme(legend.position="bottom")

ggplot(data = master_data, aes(fill = prop_bus)) + geom_sf(aes(geometry=geometry)) + scale_fill_distiller(palette = "YlOrRd", direction = 1) + labs(title = "Proportion of population that commutes by bus") + theme_void() + theme(legend.position="bottom")

ggplot(data = master_data, aes(fill = prop_old)) + geom_sf(aes(geometry=geometry)) + scale_fill_distiller(palette = "YlOrRd", direction = 1) + labs(title = "Proportion of population 65+ years of age") + theme_void() + theme(legend.position="bottom")
# + rescale(master_data$prop_old, to = c(0.050, 0.20 ))

#ggplot(data = master_data, aes(fill = vars())) + geom_sf(aes(geometry=geometry)) + facet_wrap(vars())

save(master_data, file = 'master_data.RData')
#load('master_data.RData') 

```


##Read in the Covid data
```{r read in covid data and display}

covid_data_april1st <- read_csv("tests-by-zcta_april1st.csv") %>% mutate (GEOID = as.character(MODZCTA)) 
covid_data_may1st <- read_csv("tests-by-zcta_may1st.csv") %>% mutate (GEOID = as.character(MODZCTA))
#head(covid_data_april1st)
#head(covid_data_may1st)

```


##Do R^2 regressions on all the metrics above
```{r combine and model}
#four plus model
april1_fourplus <- inner_join(prop_fourbyzip, covid_data_april1st, on = "GEOID") %>% mutate(prop_pos = Positive / Total)
#head(april1_fourplus)

fourplus_model <-  lm(prop_pos ~ prop_fourplus, april1_fourplus)
summary(fourplus_model)$r.squared
#fourplus_model

april1_fourplus <- april1_fourplus %>% add_predictions(fourplus_model)


##18-64 uninsured model
april1_uninsured <- inner_join(uninsured_18to65_byzip, covid_data_april1st, on = "GEOID") %>% mutate(prop_pos = Positive / Total)
#head(april1_uninsured)

uninsured_model <-  lm(prop_pos ~ prop_uninsured, april1_uninsured)
summary(uninsured_model)$r.squared
#uninsured_model

april1_uninsured <- april1_uninsured %>% add_predictions(uninsured_model)


##white model
april1_white <- inner_join(prop_of_white, covid_data_april1st, on = "GEOID") %>% mutate(prop_pos = Positive / Total)
#head(april1_white)

white_model <-  lm(prop_pos ~ prop_white, april1_white)
summary(white_model)$r.squared
#white_model

april1_white <- april1_white %>% add_predictions(white_model)


##median income model
april1_median <- inner_join(income_byzip, covid_data_april1st, on = "GEOID") %>% mutate(prop_pos = Positive / Total)

median_model <-  lm(prop_pos ~ median_income, april1_median)
summary(median_model)$r.squared
#median_model

april1_median <- april1_median %>% add_predictions(median_model)


## using bus model
april1_bus <- inner_join(prop_public_transport, covid_data_april1st, on = "GEOID") %>% mutate(prop_pos = Positive / Total)
#head(april1_bus)

bus_model <-  lm(prop_pos ~ prop_bus, april1_bus)
summary(bus_model)$r.squared
bus_model

april1_bus <- april1_bus %>% add_predictions(bus_model)


## older than 65 model
april1_old <- inner_join(prop_old_people, covid_data_april1st, on = "GEOID") %>% mutate(prop_pos = Positive / Total)
head(april1_old)

old_model <-  lm(prop_pos ~ prop_old, april1_old)
summary(old_model)$r.squared
#old_model

april1_old <- april1_old %>% add_predictions(old_model)



## top 4 model
april1_top4 <- list(prop_fourbyzip, uninsured_18to65_byzip, prop_of_white,income_byzip, covid_data_april1st) %>%  reduce(inner_join, by = "GEOID") %>% mutate(prop_pos = Positive / Total) %>% select(GEOID, prop_fourplus, prop_uninsured, prop_white, median_income, prop_pos, geometry)
head(april1_top4)

top4_model <-  lm(prop_pos ~ prop_fourplus + prop_uninsured + prop_white +  median_income, april1_top4)
summary(top4_model)#$r.squared
top4_model

april1_top4 <- april1_top4 %>% add_predictions(top4_model)

april1_top4
```

##Notes

living in a household with 4 or more individuals (R2 = 41%).
proportion of 18-64 adults who are uninsured (38%) 
proportion of population self-identifying as white (34%) 
median income (32%) 

change in mobility (19%)                                                 ????
proportion using bus for commute (13%)                                   off by %10.5
proportion elderly (3%)

 Sequentially including variables in our prediction model in order of decreasing R2 resulted in a model with four SES variables that explained 56% of the total variability in COVID-19 positivity                



geom_violin
play with date as factor
must be done in r server?
load('/data/safegraph/safegraph.Rdata')
